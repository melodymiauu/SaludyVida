{% extends "base.html" %}

{% block title %}Buscar Citas{% endblock %}

{% block content %}

<!-- Título -->
<div class="mb-4">
    <h2 class="mb-0">Buscar Citas Médicas</h2>
</div>

<!-- 1. Tarjeta del Formulario (Más ordenada) -->
<div class="card shadow-sm mb-5">
    <div class="card-header bg-light">
        <h5 class="mb-0 text-muted" style="font-size: 1rem;">Filtros de Búsqueda</h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            
            <!-- Campo Fecha -->
            <div class="col-md-4">
                <label for="fecha" class="form-label fw-bold">Fecha</label>
                <input type="date" name="fecha" id="fecha" class="form-control" value="{{ request.GET.fecha }}">
            </div>

            <!-- Campo Médico -->
            <div class="col-md-4">
                <label for="medico" class="form-label fw-bold">Médico</label>
                <select name="medico" id="medico" class="form-select">
                    <option value="">-- Todos los médicos --</option>
                    {% for m in medicos %}
                        <option value="{{ m.id }}" {% if request.GET.medico == m.id|stringformat:"s" %}selected{% endif %}>
                            {{ m.nombre_completo }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Campo Paciente -->
            <div class="col-md-4">
                <label for="paciente" class="form-label fw-bold">Paciente</label>
                <select name="paciente" id="paciente" class="form-select">
                    <option value="">-- Todos los pacientes --</option>
                    {% for p in pacientes %}
                        <option value="{{ p.id }}" {% if request.GET.paciente == p.id|stringformat:"s" %}selected{% endif %}>
                            {{ p.nombre_completo }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Botones de Acción -->
            <div class="col-12 d-flex gap-2 mt-4">
                <button class="btn btn-primary" type="submit">
                    Buscar
                </button>
                <!-- El botón limpiar recarga la página sin filtros -->
                <a href="{% url 'buscar_citas' %}" class="btn btn-secondary">
                    Limpiar
                </a>
            </div>
        </form>
    </div>
</div>


<!-- 2. RESULTADOS (Solo visibles SI se ha presionado buscar) -->
{% if request.GET %}
    
    <h4 class="mb-3">Resultados de la búsqueda:</h4>

    {% if citas %}
        <!-- Tabla con el mismo estilo moderno de las otras páginas -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Fecha y Hora</th>
                                <th scope="col">Paciente</th>
                                <th scope="col">Médico</th>
                                <th scope="col">Especialidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas %}
                            <tr>
                                <td class="fw-bold">
                                    {{ cita.fecha_cita|date:"d/m/Y" }} - {{ cita.hora_cita|time:"H:i" }}
                                </td>
                                <td>{{ cita.paciente.nombre_completo }}</td>
                                <td>{{ cita.medico.nombre_completo }}</td>
                                <td>
                                    <span class="badge bg-info text-dark">
                                        {{ cita.get_especialidad_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Mensaje bonito si buscó pero no encontró nada -->
        <div class="alert alert-warning text-center py-4">
            <h5>No se encontraron resultados</h5>
            <p class="mb-0">Intenta cambiar los filtros de búsqueda.</p>
        </div>
    {% endif %}

{% endif %}

{% endblock %}